name: Build and Deploy LaTeX Notes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BUILD_DIR: public

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1: è·å–ä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²ï¼Œä¾¿äºè·å–æ–‡ä»¶ä¿®æ”¹æ—¶é—´

    # æ­¥éª¤2: å®‰è£… LaTeX ç¯å¢ƒ
    - name: Setup LaTeX environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-latex-recommended \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-lang-chinese \
          texlive-science \
          texlive-pictures

    # æ­¥éª¤3: ç¼–è¯‘æ‰€æœ‰ç¬”è®°
    - name: Compile all notes
      run: |
        mkdir -p $BUILD_DIR/notes
        
        # æŸ¥æ‰¾æ‰€æœ‰ç¬”è®°ä¸»æ–‡ä»¶å¹¶ç¼–è¯‘
        find notes -name "main.tex" -type f | while read texfile; do
          dir=$(dirname "$texfile")
          name=$(basename "$dir")
          echo "ğŸ“ ç¼–è¯‘ç¬”è®°: $name"
          
          # è¿›å…¥ç¬”è®°ç›®å½•ç¼–è¯‘
          cd "$dir"
          
          # è®¾ç½®æœç´¢è·¯å¾„å¹¶ç¼–è¯‘ï¼ˆä½¿ç”¨ pdflatexï¼Œäº‘ç«¯ç¯å¢ƒå·²é…ç½®å¥½ä¸­æ–‡ï¼‰
          TEXINPUTS="../../styles:" pdflatex -interaction=nonstopmode main.tex
          
          # æ£€æŸ¥æ˜¯å¦ç¼–è¯‘æˆåŠŸ
          if [ -f "main.pdf" ]; then
            cp main.pdf "../../$BUILD_DIR/notes/${name}.pdf"
            echo "âœ… æˆåŠŸ: $name"
          else
            echo "âŒ å¤±è´¥: $name"
          fi
          
          # è¿”å›é¡¹ç›®æ ¹ç›®å½•
          cd - > /dev/null
        done

    # æ­¥éª¤4: ç”Ÿæˆç´¢å¼•é¡µé¢
    - name: Generate index page
      run: |
        cat > $BUILD_DIR/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>æˆ‘çš„å­¦ä¹ ç¬”è®°</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    line-height: 1.6;
                    margin: 0;
                    padding: 20px;
                    background: #f5f5f5;
                    color: #333;
                }
                .container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                header {
                    text-align: center;
                    margin-bottom: 40px;
                    border-bottom: 2px solid #eaeaea;
                    padding-bottom: 20px;
                }
                h1 {
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .subtitle {
                    color: #7f8c8d;
                    font-size: 1.1em;
                }
                .notes-grid {
                    display: grid;
                    gap: 20px;
                }
                .note-card {
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 20px;
                    background: #fafafa;
                    transition: all 0.3s ease;
                }
                .note-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    border-color: #3498db;
                }
                .note-title {
                    color: #2c3e50;
                    margin-top: 0;
                    margin-bottom: 10px;
                }
                .note-link {
                    display: inline-block;
                    background: #3498db;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 5px;
                    text-decoration: none;
                    margin-top: 10px;
                    transition: background 0.3s ease;
                }
                .note-link:hover {
                    background: #2980b9;
                }
                .last-updated {
                    font-size: 0.9em;
                    color: #7f8c8d;
                    margin-top: 10px;
                }
                .empty-state {
                    text-align: center;
                    padding: 40px;
                    color: #7f8c8d;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <header>
                    <h1>ğŸ“š æˆ‘çš„å­¦ä¹ ç¬”è®°</h1>
                    <p class="subtitle">è‡ªåŠ¨ä» LaTeX æºç ç”Ÿæˆ â€¢ æœ€åæ›´æ–°: <span id="update-date"></span></p>
                </header>
                
                <div class="notes-grid" id="notes-container">
        EOF
        
        # åŠ¨æ€æ·»åŠ ç¬”è®°å¡ç‰‡
        find notes -name "main.tex" | while read texfile; do
          dir=$(dirname "$texfile")
          name=$(basename "$dir")
          
          # ä»LaTeXæ–‡ä»¶ä¸­æå–æ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          title=$(grep -m 1 '\\title{' "$texfile" | sed 's/.*{//' | sed 's/}.*//' 2>/dev/null || echo "$name")
          # è·å–æœ€åä¿®æ”¹æ—¶é—´
          last_modified=$(git log -1 --format="%cd" --date=short "$texfile" 2>/dev/null || echo "æœªçŸ¥")
          
          cat >> $BUILD_DIR/index.html << EOF
                    <div class="note-card">
                        <h3 class="note-title">$title</h3>
                        <p>è‡ªåŠ¨ç”Ÿæˆçš„ç¬”è®°PDFæ–‡ä»¶</p>
                        <a href="notes/${name}.pdf" class="note-link" target="_blank">æŸ¥çœ‹PDF</a>
                        <div class="last-updated">æ›´æ–°: $last_modified</div>
                    </div>
        EOF
        done
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¬”è®°
        if [ -z "$(find notes -name "main.tex")" ]; then
          cat >> $BUILD_DIR/index.html << EOF
                    <div class="empty-state">
                        <h3>è¿˜æ²¡æœ‰ç¬”è®°</h3>
                        <p>åœ¨ notes/ ç›®å½•ä¸‹åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªç¬”è®°å§ï¼</p>
                    </div>
        EOF
        fi
        
        cat >> $BUILD_DIR/index.html << 'EOF'
                </div>
            </div>
            
            <script>
                // æ˜¾ç¤ºå½“å‰æ—¥æœŸ
                document.getElementById('update-date').textContent = new Date().toLocaleDateString('zh-CN');
                
                // ç®€å•çš„æœç´¢åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
                console.log('ç¬”è®°ç³»ç»Ÿå·²åŠ è½½å®Œæˆï¼');
            </script>
        </body>
        </html>
        EOF

    # æ­¥éª¤5: éƒ¨ç½²åˆ° GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        force_orphan: true  # æ¯æ¬¡éƒ¨ç½²éƒ½æ¸…ç†æ—§æ–‡ä»¶
